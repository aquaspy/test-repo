<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSH Tunnel Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        body {
            padding-top: 20px;
        }
        .connection-card {
            margin-bottom: 15px;
        }
        .status-active {
            color: #198754;
        }
        .status-inactive {
            color: #dc3545;
        }
        .key-card {
            margin-bottom: 15px;
        }
        .tab-content {
            padding-top: 20px;
        }
        .action-buttons {
            white-space: nowrap;
        }
        .table-responsive {
            overflow-x: auto;
        }
        .copy-btn {
            cursor: pointer;
        }
        .public-key-container {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            word-break: break-all;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">SSH Tunnel Manager</h1>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="connections-tab" data-bs-toggle="tab" data-bs-target="#connections" type="button" role="tab" aria-controls="connections" aria-selected="true">Connections</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="keys-tab" data-bs-toggle="tab" data-bs-target="#keys" type="button" role="tab" aria-controls="keys" aria-selected="false">SSH Keys</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- Connections Tab -->
            <div class="tab-pane fade show active" id="connections" role="tabpanel" aria-labelledby="connections-tab">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>Manage Connections</h3>
                    <button class="btn btn-primary" id="add-connection-btn">
                        <i class="bi bi-plus-circle"></i> Add Connection
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Local Port</th>
                                <th>Remote Port</th>
                                <th>VPS IP</th>
                                <th>SSH Port</th>
                                <th>User</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="connections-table-body">
                            <!-- Connections will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SSH Keys Tab -->
            <div class="tab-pane fade" id="keys" role="tabpanel" aria-labelledby="keys-tab">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>SSH Keys</h3>
                    <button class="btn btn-primary" id="generate-key-btn">
                        <i class="bi bi-key"></i> Generate New Key
                    </button>
                </div>

                <div id="ssh-keys-container">
                    <!-- SSH keys will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Connection Modal -->
    <div class="modal fade" id="connection-modal" tabindex="-1" aria-labelledby="connectionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="connectionModalLabel">Add Connection</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="connection-form">
                        <input type="hidden" id="connection-id">
                        <div class="mb-3">
                            <label for="connection-name" class="form-label">Connection Name</label>
                            <input type="text" class="form-control" id="connection-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="local-port" class="form-label">Local Port</label>
                            <input type="number" class="form-control" id="local-port" min="1" max="65535" value="8096" required>
                        </div>
                        <div class="mb-3">
                            <label for="remote-port" class="form-label">Remote Port</label>
                            <input type="number" class="form-control" id="remote-port" min="1" max="65535" value="1111" required>
                        </div>
                        <div class="mb-3">
                            <label for="vps-ip" class="form-label">VPS IP Address</label>
                            <input type="text" class="form-control" id="vps-ip" required>
                        </div>
                        <div class="mb-3">
                            <label for="vps-user" class="form-label">VPS User</label>
                            <input type="text" class="form-control" id="vps-user" value="root">
                        </div>
                        <div class="mb-3">
                            <label for="ssh-port" class="form-label">SSH Port</label>
                            <input type="number" class="form-control" id="ssh-port" min="1" max="65535" value="22" required>
                        </div>
                        <div class="mb-3">
                            <label for="key-path" class="form-label">SSH Key Path</label>
                            <select class="form-control" id="key-path" required>
                                <option value="">Select SSH Key</option>
                                <!-- SSH keys will be loaded here -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="alive-interval" class="form-label">Keep Alive Interval (seconds)</label>
                            <input type="number" class="form-control" id="alive-interval" min="10" max="300" value="60" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-connection-btn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Generate SSH Key Modal -->
    <div class="modal fade" id="generate-key-modal" tabindex="-1" aria-labelledby="generateKeyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="generateKeyModalLabel">Generate SSH Key</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="generate-key-form">
                        <div class="mb-3">
                            <label for="key-name" class="form-label">Key Name</label>
                            <input type="text" class="form-control" id="key-name" value="id_rsa" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="generate-key-submit-btn">Generate</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Public Key Modal -->
    <div class="modal fade" id="public-key-modal" tabindex="-1" aria-labelledby="publicKeyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="publicKeyModalLabel">Public Key</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Copy this public key to your VPS's authorized_keys file:</p>
                    <div class="public-key-container" id="public-key-content"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="copy-public-key-btn">
                        <i class="bi bi-clipboard"></i> Copy to Clipboard
                    </button>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    // Connect to WebSocket for real-time updates
    const socket = io();

    // Bootstrap modals
    const connectionModal = new bootstrap.Modal(document.getElementById('connection-modal'));
    const generateKeyModal = new bootstrap.Modal(document.getElementById('generate-key-modal'));
    const publicKeyModal = new bootstrap.Modal(document.getElementById('public-key-modal'));

    // DOM elements
    const connectionsTableBody = document.getElementById('connections-table-body');
    const sshKeysContainer = document.getElementById('ssh-keys-container');
    const keyPathSelect = document.getElementById('key-path');
    const publicKeyContent = document.getElementById('public-key-content');
    const addConnectionBtn = document.getElementById('add-connection-btn');
    const generateKeyBtn = document.getElementById('generate-key-btn');
    const saveConnectionBtn = document.getElementById('save-connection-btn');
    const generateKeySubmitBtn = document.getElementById('generate-key-submit-btn');
    const copyPublicKeyBtn = document.getElementById('copy-public-key-btn');

    // Add event listeners for main buttons
    addConnectionBtn.addEventListener('click', () => {
        document.getElementById('connection-form').reset();
        document.getElementById('connection-id').value = '';
        document.getElementById('connectionModalLabel').textContent = 'Add Connection';
        connectionModal.show();
    });

    generateKeyBtn.addEventListener('click', () => {
        document.getElementById('generate-key-form').reset();
        generateKeyModal.show();
    });

    saveConnectionBtn.addEventListener('click', saveConnection);
    generateKeySubmitBtn.addEventListener('click', generateKey);
    copyPublicKeyBtn.addEventListener('click', copyPublicKey);

    // Load connections
    function loadConnections() {
        fetch('/api/connections')
            .then(response => response.json())
            .then(connections => {
                connectionsTableBody.innerHTML = '';

                if (connections.length === 0) {
                    connectionsTableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center">No connections found. Click "Add Connection" to create one.</td>
                        </tr>
                    `;
                    return;
                }

                connections.forEach(conn => {
                    const row = document.createElement('tr');

                    row.innerHTML = `
                        <td>${conn.name}</td>
                        <td>${conn.local_port}</td>
                        <td>${conn.remote_port}</td>
                        <td>${conn.vps_ip}</td>
                        <td>${conn.ssh_port}</td>
                        <td>${conn.vps_user || '-'}</td>
                        <td>
                            <span class="${conn.active ? 'status-active' : 'status-inactive'}">
                                <i class="bi ${conn.active ? 'bi-check-circle-fill' : 'bi-x-circle-fill'}"></i>
                                ${conn.active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td class="action-buttons">
                            ${conn.active ? 
                                `<button class="btn btn-sm btn-danger stop-btn" data-name="${conn.name}">
                                    <i class="bi bi-stop-fill"></i> Stop
                                </button>` : 
                                `<button class="btn btn-sm btn-success start-btn" data-name="${conn.name}">
                                    <i class="bi bi-play-fill"></i> Start
                                </button>`
                            }
                            <button class="btn btn-sm btn-primary edit-btn" data-name="${conn.name}">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-danger delete-btn" data-name="${conn.name}">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </td>
                    `;

                    connectionsTableBody.appendChild(row);
                });

                // Add event listeners
                document.querySelectorAll('.start-btn').forEach(btn => {
                    btn.addEventListener('click', startConnection);
                });

                document.querySelectorAll('.stop-btn').forEach(btn => {
                    btn.addEventListener('click', stopConnection);
                });

                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', editConnection);
                });

                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', deleteConnection);
                });
            })
            .catch(error => {
                console.error('Error loading connections:', error);
                alert('Failed to load connections. Please check the console for details.');
            });
    }

    // Load SSH keys
    function loadSSHKeys() {
        fetch('/api/ssh-keys')
            .then(response => response.json())
            .then(keys => {
                sshKeysContainer.innerHTML = '';
                keyPathSelect.innerHTML = '<option value="">Select SSH Key</option>';

                if (keys.length === 0) {
                    sshKeysContainer.innerHTML = `
                        <div class="alert alert-info">
                            No SSH keys found. Click "Generate New Key" to create one.
                        </div>
                    `;
                    return;
                }

                keys.forEach(key => {
                    // Add to SSH keys container
                    const keyCard = document.createElement('div');
                    keyCard.className = 'card key-card';

                    keyCard.innerHTML = `
                        <div class="card-body">
                            <h5 class="card-title">${key.name}</h5>
                            <p class="card-text">Path: ${key.path}</p>
                            <button class="btn btn-sm btn-primary view-public-key-btn" data-name="${key.name}" ${!key.has_public_key ? 'disabled' : ''}>
                                <i class="bi bi-key"></i> View Public Key
                            </button>
                        </div>
                    `;

                    sshKeysContainer.appendChild(keyCard);

                    // Add to key path select
                    const option = document.createElement('option');
                    option.value = key.path;
                    option.textContent = key.name;
                    keyPathSelect.appendChild(option);
                });

                // Add event listeners
                document.querySelectorAll('.view-public-key-btn').forEach(btn => {
                    btn.addEventListener('click', viewPublicKey);
                });
            })
            .catch(error => {
                console.error('Error loading SSH keys:', error);
                alert('Failed to load SSH keys. Please check the console for details.');
            });
    }

    // Start connection
    function startConnection(event) {
        const name = event.currentTarget.dataset.name;

        fetch(`/api/connections/${name}/start`, {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadConnections();
                } else {
                    alert(`Failed to start connection: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Error starting connection:', error);
                alert('Failed to start connection. Please check the console for details.');
            });
    }

    // Stop connection
    function stopConnection(event) {
        const name = event.currentTarget.dataset.name;

        fetch(`/api/connections/${name}/stop`, {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadConnections();
                } else {
                    alert(`Failed to stop connection: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Error stopping connection:', error);
                alert('Failed to stop connection. Please check the console for details.');
            });
    }

    // Edit connection
    function editConnection(event) {
        const name = event.currentTarget.dataset.name;

        fetch(`/api/connections`)
            .then(response => response.json())
            .then(connections => {
                const conn = connections.find(c => c.name === name);
                if (!conn) {
                    alert(`Connection "${name}" not found.`);
                    return;
                }

                document.getElementById('connection-id').value = name;
                document.getElementById('connection-name').value = conn.name;
                document.getElementById('local-port').value = conn.local_port;
                document.getElementById('remote-port').value = conn.remote_port;
                document.getElementById('vps-ip').value = conn.vps_ip;
                document.getElementById('vps-user').value = conn.vps_user || '';
                document.getElementById('ssh-port').value = conn.ssh_port;
                document.getElementById('key-path').value = conn.key_path;
                document.getElementById('alive-interval').value = conn.alive_interval;

                document.getElementById('connectionModalLabel').textContent = `Edit Connection: ${name}`;
                connectionModal.show();
            })
            .catch(error => {
                console.error('Error loading connection details:', error);
                alert('Failed to load connection details. Please check the console for details.');
            });
    }

    // Delete connection
    function deleteConnection(event) {
        const name = event.currentTarget.dataset.name;

        if (!confirm(`Are you sure you want to delete connection "${name}"?`)) {
            return;
        }

        fetch(`/api/connections/${name}`, {
            method: 'DELETE'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadConnections();
                } else {
                    alert(`Failed to delete connection: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Error deleting connection:', error);
                alert('Failed to delete connection. Please check the console for details.');
            });
    }

    // Save connection (add or update)
    function saveConnection() {
        const connectionId = document.getElementById('connection-id').value;
        const isEdit = !!connectionId;

        const connectionData = {
            name: document.getElementById('connection-name').value,
            local_port: parseInt(document.getElementById('local-port').value),
            remote_port: parseInt(document.getElementById('remote-port').value),
            vps_ip: document.getElementById('vps-ip').value,
            vps_user: document.getElementById('vps-user').value,
            ssh_port: parseInt(document.getElementById('ssh-port').value),
            key_path: document.getElementById('key-path').value,
            alive_interval: parseInt(document.getElementById('alive-interval').value)
        };

        // Validate required fields
        if (!connectionData.name || !connectionData.vps_ip || !connectionData.key_path) {
            alert('Please fill in all required fields.');
            return;
        }

        const url = isEdit ? `/api/connections/${connectionId}` : '/api/connections';
        const method = isEdit ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(connectionData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    connectionModal.hide();
                    loadConnections();
                } else {
                    alert(`Failed to save connection: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Error saving connection:', error);
                alert('Failed to save connection. Please check the console for details.');
            });
    }

    // Generate SSH key
    function generateKey() {
        const keyName = document.getElementById('key-name').value;

        if (!keyName) {
            alert('Please enter a key name.');
            return;
        }

        fetch('/api/ssh-keys', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name: keyName })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    generateKeyModal.hide();
                    loadSSHKeys();
                    alert(`SSH key "${keyName}" generated successfully.`);
                } else {
                    alert(`Failed to generate SSH key: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Error generating SSH key:', error);
                alert('Failed to generate SSH key. Please check the console for details.');
            });
    }

    // View public key
    function viewPublicKey(event) {
        const keyName = event.currentTarget.dataset.name;

        fetch(`/api/ssh-keys/${keyName}/public`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    publicKeyContent.textContent = data.public_key;
                    document.getElementById('publicKeyModalLabel').textContent = `Public Key: ${keyName}`;
                    publicKeyModal.show();
                } else {
                    alert(`Failed to load public key: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Error loading public key:', error);
                alert('Failed to load public key. Please check the console for details.');
            });
    }

    // Copy public key to clipboard
    function copyPublicKey() {
        const publicKey = publicKeyContent.textContent;

        if (!publicKey) {
            alert('No public key to copy.');
            return;
        }

        navigator.clipboard.writeText(publicKey)
            .then(() => {
                alert('Public key copied to clipboard.');
            })
            .catch(error => {
                console.error('Error copying to clipboard:', error);
                alert('Failed to copy to clipboard. Please select and copy manually.');
            });
    }

    // Listen for real-time updates
    socket.on('status_update', connections => {
        loadConnections();
    });

    // Load data on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadConnections();
        loadSSHKeys();
    });
</script>
